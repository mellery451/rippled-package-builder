#!/usr/bin/make -f
export DH_VERBOSE = 1
export DH_OPTIONS = -v
export BOOST_ROOT=/opt/local/boost
export NIH_CACHE_ROOT=/opt/local/nih_cache
# debuild sets some warnings that don't work well
# for our curent build..so try to remove those flags here:
export CFLAGS:=$(subst -Wformat,,$(CFLAGS))
export CFLAGS:=$(subst -Werror=format-security,,$(CFLAGS))
export CXXFLAGS:=$(subst -Wformat,,$(CXXFLAGS))
export CXXFLAGS:=$(subst -Werror=format-security,,$(CXXFLAGS))

%:
	dh $@ --with systemd

override_dh_auto_configure:
	env
	rm -rf bld
	mkdir -p bld
	cd bld && \
	/opt/local/cmake/bin/cmake .. \
		-DCMAKE_INSTALL_PREFIX=/opt/ripple \
		-DCMAKE_BUILD_TYPE=Release \
		-Dstatic=true \
		-DCMAKE_VERBOSE_MAKEFILE=ON

override_dh_auto_build:
	cd bld && \
	/opt/local/cmake/bin/cmake --build . --parallel 3 -- verbose=1

override_dh_auto_install:
	cd bld && DESTDIR=../debian/tmp /opt/local/cmake/bin/cmake --build . --target install -- verbose=1
	rm -rf bld_vl
	mkdir -p bld_vl
	cd bld_vl && \
	/opt/local/cmake/bin/cmake ../../validator-keys-tool \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_PREFIX_PATH=../debian/tmp/opt/ripple/ \
		-Dstatic=true \
		-DCMAKE_VERBOSE_MAKEFILE=ON && \
	/opt/local/cmake/bin/cmake --build . --parallel 3 -- verbose=1
	install -D bld_vl/validator-keys debian/tmp/opt/ripple/bin/validator-keys
	rm -rf bld
	rm -rf bld_vl
